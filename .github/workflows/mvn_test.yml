name: Build packer image after merge

on:
  pull_request:
    types: [closed]

env:
  AMI_ID: ""
  GCP_IMAGE_NAME: ""

jobs:
  if_merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    env:
      CLOUD_PROVIDER: ${{ secrets.CLOUD_PROVIDER }}
      TOPIC: ${{ secrets.TOPIC }}

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Google cloud auth
        if: env.CLOUD_PROVIDER == 'gcp'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        if: env.CLOUD_PROVIDER == 'gcp'
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure AWS Credentials
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Start MySQL
        run: |
          sudo /etc/init.d/mysql start
          mysql -e "CREATE DATABASE IF NOT EXISTS ${{ secrets.CSYE6225_MSQL_DB_NAME }};" -u${{ secrets.CSYE6225_MSQL_DB_USER }} -p${{ secrets.CSYE6225_MSQL_DB_PWD }}

      - name: Write spring config (GCP)
        if: env.CLOUD_PROVIDER == 'gcp'
        uses: DamianReeves/write-file-action@master
        with:
          path: "src/main/resources/application.properties"
          write-mode: overwrite
          contents: |
            spring.datasource.url=${{ secrets.CSYE6225_MSQL_DB_CONNSTR }}
            spring.datasource.username=${{ secrets.CSYE6225_MSQL_DB_USER }}
            spring.datasource.password=${{ secrets.CSYE6225_MSQL_DB_PWD }}
            spring.datasource.driverClassName=com.mysql.cj.jdbc.Driver
            spring.mvc.converters.preferred-json-mapper=gson
            spring.cloud.gcp.pubsub.enabled=true
            spring.cloud.gcp.core.enabled=true
            spring.cloud.gcp.project-id=${{ secrets.CSYE6225_PROJECT_ID }}
            spring.profiles.active=gcp
            server.port=${{ secrets.CSYE6225_SERVER_PORT }}

      - name: Write spring config (AWS)
        if: env.CLOUD_PROVIDER == 'aws'
        uses: DamianReeves/write-file-action@master
        with:
          path: "src/main/resources/application.properties"
          write-mode: overwrite
          contents: |
            spring.datasource.url=${{ secrets.CSYE6225_MSQL_DB_CONNSTR }}
            spring.datasource.username=${{ secrets.CSYE6225_MSQL_DB_USER }}
            spring.datasource.password=${{ secrets.CSYE6225_MSQL_DB_PWD }}
            spring.datasource.driverClassName=com.mysql.cj.jdbc.Driver
            spring.mvc.converters.preferred-json-mapper=gson
            spring.cloud.gcp.pubsub.enabled=false
            spring.cloud.gcp.core.enabled=false
            spring.profiles.active=aws
            server.port=${{ secrets.CSYE6225_SERVER_PORT }}

      - name: Write application-aws.properties
        if: env.CLOUD_PROVIDER == 'aws'
        uses: DamianReeves/write-file-action@master
        with:
          path: "src/main/resources/application-aws.properties"
          write-mode: overwrite
          contents: |
            aws.region=${{ secrets.AWS_REGION }}

      - name: Build application with Maven
        run: mvn clean install

      - name: Setup packer
        uses: hashicorp/setup-packer@main
        with:
          version: latest

      - name: Packer init
        run: packer init .

      - name: Packer validate
        run: packer validate .

      - name: Packer build (AWS)
        if: env.CLOUD_PROVIDER == 'aws'
        run: |
          set -euo pipefail
          packer build -only="amazon-ebs.ec2-ami" -machine-readable . | tee packer.log
          RAW_ID=$(awk -F, '$0 ~ /artifact,0,id/ {print $6; exit}' packer.log)
          AMI_ID="${RAW_ID##*:}"
          echo "AMI_ID=${AMI_ID}" >> $GITHUB_ENV
          echo "Built AMI: ${AMI_ID}"

      - name: Packer build (GCP)
        if: env.CLOUD_PROVIDER == 'gcp'
        run: |
          set -euo pipefail
          packer build -only="googlecompute.gcp-image" -machine-readable . | tee packer.log
          IMAGE_NAME=$(grep -m 1 "A disk image was created" packer.log | awk '{print $NF}')
          echo "GCP_IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "Built GCP image: ${IMAGE_NAME}"

      - name: Configure AWS Credentials (DEMO)
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create New Launch Template Version with AMI
        if: env.CLOUD_PROVIDER == 'aws'
        run: |
          set -euo pipefail
          aws ec2 create-launch-template-version \
            --launch-template-name "${{ secrets.LAUNCH_TEMPLATE_NAME }}" \
            --source-version '$Latest' \
            --launch-template-data "{\"ImageId\":\"${{ env.AMI_ID }}\"}"

      - name: Update Auto Scaling Group to use $Latest LT version
        if: env.CLOUD_PROVIDER == 'aws'
        run: |
          set -euo pipefail
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name "${{ secrets.ASG_NAME }}" \
            --launch-template "LaunchTemplateName=${{ secrets.LAUNCH_TEMPLATE_NAME }},Version='$Latest'"

      - name: Start Instance Refresh
        if: env.CLOUD_PROVIDER == 'aws'
        run: |
          set -euo pipefail
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "${{ secrets.ASG_NAME }}"

      - name: Get source instance name + zone (GCP)
        if: env.CLOUD_PROVIDER == 'gcp'
        run: |
          set -euo pipefail
          read -r name zone <<< $(gcloud compute instance-groups managed list-instances ${{ secrets.MIG_NAME }} --region=${{ secrets.REGION }} | awk '/RUNNING/{print $1, $2; exit}')
          echo "SOURCE_INSTANCE_NAME=$name" >> $GITHUB_ENV
          echo "ZONE=$zone" >> $GITHUB_ENV

      - name: Recreate instance template (GCP)
        if: env.CLOUD_PROVIDER == 'gcp'
        run: |
          set -euo pipefail
          TEMPLATE_NAME="${{ secrets.INSTANCE_TEMPLATE_PREFIX }}-$(date +%s)"
          gcloud compute instance-templates create "${TEMPLATE_NAME}" \
            --source-instance="${{ env.SOURCE_INSTANCE_NAME }}" \
            --source-instance-zone="${{ env.ZONE }}" \
            --instance-template-region="${{ secrets.REGION }}" \
            --configure-disk=device-name=${{ secrets.DISK_DEVICE_NAME }},instantiate-from=custom-image,custom-image=projects/${{ secrets.CSYE6225_PROJECT_ID }}/global/images/${{ env.GCP_IMAGE_NAME }},auto-delete=true
          echo "TEMPLATE_NAME=${TEMPLATE_NAME}" >> $GITHUB_ENV

      - name: Update MIG with new template (GCP)
        if: env.CLOUD_PROVIDER == 'gcp'
        run: |
          set -euo pipefail
          gcloud compute instance-groups managed set-instance-template ${{ secrets.MIG_NAME }} \
            --template=projects/${{ secrets.CSYE6225_PROJECT_ID }}/regions/${{ secrets.REGION }}/instanceTemplates/${{ env.TEMPLATE_NAME }} \
            --region=${{ secrets.REGION }}

      - name: Rolling start update (GCP)
        if: env.CLOUD_PROVIDER == 'gcp'
        run: |
          set -euo pipefail
          gcloud compute instance-groups managed rolling-action start-update ${{ secrets.MIG_NAME }} \
            --version=template=projects/${{ secrets.CSYE6225_PROJECT_ID }}/regions/${{ secrets.REGION }}/instanceTemplates/${{ env.TEMPLATE_NAME }} \
            --region=${{ secrets.REGION }}

      - name: Update status check (GCP)
        if: env.CLOUD_PROVIDER == 'gcp'
        run: |
          set -euo pipefail
          gcloud compute instance-groups managed wait-until ${{ secrets.MIG_NAME }} --version-target-reached --region=${{ secrets.REGION }}
